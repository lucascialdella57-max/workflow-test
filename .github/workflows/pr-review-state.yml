name: PR Review State Automation

on:
  pull_request:
    types:
      - review_requested
  pull_request_review:
    types:
      - submitted

permissions:
  pull-requests: write
  contents: read

jobs:
  manage-pr-labels:
    runs-on: ubuntu-latest

    steps:
      - name: Manage PR state labels
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const eventName = context.eventName;

            const labels = pr.labels.map(label => label.name);

            async function removeLabel(name) {
              if (labels.includes(name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: name
                });
              }
            }

            async function addLabel(name) {
              if (!labels.includes(name)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: [name]
                });
              }
            }

            if (eventName === "pull_request" &&
                context.payload.action === "review_requested") {

              if (labels.includes("waiting for changes")) {
                await removeLabel("waiting for changes");
                await addLabel("waiting for review");
              }

              return;
            }

            if (eventName === "pull_request_review" &&
                context.payload.action === "submitted") {

              const reviewState = context.payload.review.state;

              if (reviewState === "changes_requested") {
                await removeLabel("waiting for review");
                await removeLabel("ready");
                await addLabel("waiting for changes");
              }

              if (reviewState === "approved") {
                await removeLabel("waiting for review");
                await removeLabel("waiting for changes");
                await addLabel("ready");
              }
            }
